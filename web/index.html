<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MTG Price Checker for Singapore's LGS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
</head>
<body>
<div class="container-fluid mt-3">
    <div class="mb-3 text-center">
        <div class="d-flex flex-row align-items-center justify-content-center mb-1">
            <div><img style="width: 140px;" src="img/gishalt-fetch-web.jpeg"/></div>
        </div>
        <div>
            <h3>Magic: The Gathering Price Checker for Singapore's LGS</h3>
        </div>
    </div>
    <div class="mb-3">
        <form id="searchForm">
            <div class="mb-3 form-floating">
                <input type="text" class="form-control" id="search" placeholder="lightning bolt">
                <label for="search">Card Name</label>
            </div>
            <div class="mb-3" id="lgsCheckboxes"></div>
            <div class="mb-3 d-grid">
                <button id="submitBtn" type="submit" class="btn btn-primary fw-bold">Search</button>
            </div>
        </form>
    </div>
    <div id="resultCount" class="mb-3 text-center bg-warning-subtle text-dark rounded fw-bold"></div>
    <div id="result" class="mb-3 text-center"></div>

    <div class="text-center mb-3 fs-6 text-lowercase">
        <footer>
            <div>&copy; 2023 mtg.alvinyeoh.com by <a href="https://github.com/xenodus" target="_blank">xenodus</a></div>
        </footer>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script>
    const form = document.getElementById("searchForm");
    const lgsCheckboxesDiv = document.getElementById("lgsCheckboxes");
    const searchInput = document.getElementById("search");
    const submitBtn = document.getElementById("submitBtn");
    const resultDiv = document.getElementById("result");
    const resultCountDiv = document.getElementById("resultCount");
    const lgsCheckboxes = document.getElementsByName('lgs[]');

    const lgsOptions = [
        "Agora Hobby",
        "Flagship Games",
        "Games Haven",
        "Grey Ogre Games",
        "Hideout",
        "ManaPro",
        "Mox & Lotus",
        "OneMtg",
        "Sanctuary Gaming"
    ];
    let timeouts = [];

    setupConfig();

    form.addEventListener("submit", onFormSubmit);

    document.addEventListener("keypress", function(event) {
        if (event.keyCode === 13) {
            event.preventDefault();
            submitBtn.click();
        }
    });

    // Pre-select checkboxes and pre-fill search from cookie
    function setupConfig() {
        appendLgsCheckboxes();
        fillSearch();
    }

    function fillSearch() {
        if(getCookie('search') !== undefined && getCookie('search') != "") {
            searchInput.value = decodeURIComponent(getCookie('search'));
        }
    }

    function appendLgsCheckboxes() {
        let lgsSelected = [];

        if(getCookie('lgsSelected') !== undefined && getCookie('lgsSelected') != "") {
            lgsSelected = decodeURIComponent(getCookie('lgsSelected')).split(",");
        } else {
            lgsSelected = lgsOptions;
        }

        lgsCheckboxesDiv.innerHTML = '';
        for(let i=0; i<lgsOptions.length; i++) {
            let isChecked = lgsSelected.includes(lgsOptions[i]) ? "checked" : "";
            lgsCheckboxesDiv.innerHTML += `
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="lgsCheckbox`+i+`" class="lgsCheckboxes" value="`+lgsOptions[i]+`" name="lgs[]" `+isChecked+`>
              <label class="form-check-label" for="lgsCheckbox`+i+`">`+lgsOptions[i]+`</label>
            </div>
          `;
        }
    }

    function setCookie(lgs) {
        let searchCookie = "search=" +  encodeURIComponent(searchInput.value) + ";";
        let lgsCookie = "lgsSelected=" + encodeURIComponent(lgs.join(",")) + ";";

        document.cookie = searchCookie;
        document.cookie = lgsCookie;
    }

    function getCookie(name) {
        let value = `; ${document.cookie}`;
        let parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function clearTimeouts() {
        for (let i=0; i<timeouts.length; i++) {
            clearTimeout(timeouts[i]);
        }
    }

    // Timeout 15s in backend
    function updateSubmitBtnProgress() {
        submitBtn.innerHTML = "Searching LGS"

        for(let i=1; i<=15; i++){
            timeouts.push(window.setTimeout(function(){
                submitBtn.innerHTML += " ."
            }, i * 1000));
        }
    }

    function resetResult() {
        resultDiv.innerHTML = "";
        resultCountDiv.innerHTML = "";
    }

    function resetSubmitBtn() {
        clearTimeouts();
        submitBtn.innerHTML = "Search";
        submitBtn.disabled = false;
    }

    function onFormSubmit(event) {
        event.preventDefault();

        let lgsSelected = [];

        for(let i=0; i<lgsCheckboxes.length; i++) {
            if (lgsCheckboxes[i].checked) {
                lgsSelected.push(lgsCheckboxes[i].value)
            }
        }

        if (lgsSelected.length == 0) {
            lgsSelected = lgsOptions;
            for(let i=0; i<lgsCheckboxes.length; i++) {
                lgsCheckboxes[i].checked = true;
            }
        }

        // Set state to disabled
        submitBtn.disabled = true;
        // Reset result div
        resetResult();

        var request = new XMLHttpRequest();
        var searchUrl = "https://api.alvinyeoh.com/?s="+encodeURIComponent(searchInput.value);
        searchUrl += "&lgs=" + encodeURIComponent(lgsSelected.join(','));

        setCookie(lgsSelected);

        request.open("GET", searchUrl);
        request.send();

        updateSubmitBtnProgress();

        request.onreadystatechange = function() {
            if (request.readyState == XMLHttpRequest.DONE) {
                let resultCount = 0;

                // Check the status of the response
                if (request.status == 200) {
                    // Access the data returned by the server
                    var result = JSON.parse(request.responseText);
                    // Do something with the data
                    if (result.hasOwnProperty("data")) {
                        if (result["data"] !== null && result["data"].length > 0) {
                            let html = `<div class="row">`;
                            for(let i = 0; i < result["data"].length; i++) {
                                if (result["data"][i].hasOwnProperty("url")
                                    && result["data"][i].hasOwnProperty("img")
                                    && result["data"][i].hasOwnProperty("name")
                                    && result["data"][i].hasOwnProperty("price")
                                    && result["data"][i].hasOwnProperty("src")) {
                                    let h = `
                      <div class="col-lg-2 col-6 mb-3">
                        <div class="text-center">
                          <a href="`+result["data"][i]["url"]+`" target="_blank">
                            <img src="`+result["data"][i]["img"]+`" loading="lazy" class="img-fluid img-thumbnail bg-dark" alt="`+result["data"][i]["name"]+`"/>
                          </a>
                        </div>
                        <div class="text-center">
                          <div><strong>`+result["data"][i]["name"]+`</strong></div>
                          <div>S$ `+result["data"][i]["price"].toFixed(2)+`</div>
                          <div><a href="`+result["data"][i]["url"]+`" target="_blank">`+result["data"][i]["src"]+`</a></div>
                        </div>
                      </div>`;
                                    html += h
                                    resultCount++;
                                }
                            }
                            html += `</div>`
                            resultDiv.innerHTML = html;
                        }
                    }
                } else {
                    // Handle error
                }

                resultCountDiv.innerHTML = `<div class="py-2">`+resultCount+` result`+(resultCount>1?"s":"")+` found</div>`;

                // Reset state
                resetSubmitBtn();
            }
        };
    }
</script>
</body>
</html>
